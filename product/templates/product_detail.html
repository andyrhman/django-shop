{% extends "base.html" %}
{% load static %}

{% block content %}
        <div class="container-fluid py-2">
            <h1 class="text-center display-6">Shop Detail</h1>
            <ol class="breadcrumb justify-content-center mb-0">
                <li class="breadcrumb-item"><a href="#">Home</a></li>
                <li class="breadcrumb-item"><a href="{% url 'products' %}">Products</a></li>
                <li id="product-breadcrumb" class="breadcrumb-item active"></li>
            </ol>
        </div>

        <div class="container-fluid py-5 mt-5">
            <div class="container py-5">
                <div class="row g-4 mb-5">
                    <div class="col-lg-8 col-xl-9">
                        <div class="row g-4">
                            <div class="col-lg-6">
                                <div class="border rounded position-relative overflow-hidden">
                                    <div id="image-spinner" 
                                        class="spinner-border position-absolute top-50 start-50 translate-middle" 
                                        role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>

                                    <button id="prev-image" 
                                            class="btn btn-light position-absolute top-50 start-0 translate-middle-y z-2">
                                    ‹
                                    </button>

                                    <a href="#" id="product-image-link">
                                    <img id="product-image" 
                                        src="" 
                                        class="img-fluid rounded w-100" 
                                        alt="Product"
                                        style="visibility:hidden;">
                                    </a>

                                    <button id="next-image" 
                                            class="btn btn-light position-absolute top-50 end-0 translate-middle-y z-2">
                                    ›
                                    </button>
                                </div>

                                <div class="thumb-wrapper position-relative d-flex align-items-center mt-2">
                                    <button id="thumb-prev"
                                            class="btn btn-light"
                                            style="display:none; z-index:2;">
                                        ‹
                                    </button>

                                    <div id="thumb-container" class="overflow-hidden flex-grow-1 mx-3">
                                        <div id="thumbnails" class="d-flex">
                                        </div>
                                    </div>

                                    <button id="thumb-next"
                                            class="btn btn-light"
                                            style="display:none; z-index:2;">
                                        ›
                                    </button>
                                </div>
                            </div>

                            <div class="col-lg-6">
                                <h4 id="product-title" class="fw-bold mb-3"></h4>
                                <p id="product-category" class="mb-3"></p>
                                <h5 id="product-price" class="fw-bold mb-3"></h5>
                                <div id="product-rating" class="d-flex mb-4"></div>
                                <div id="variant-options" class="mb-4">
                                    <h6 class="mb-2">Variants</h6>
                                </div>

                                <div class="input-group quantity mb-5" style="width: 100px;">
                                    <div class="input-group-btn">
                                        <button class="btn btn-sm btn-minus rounded-circle bg-light border" >
                                            <i class="fa fa-minus"></i>
                                        </button>
                                    </div>
                                    <input id="qty-input" type="number"  class="form-control form-control-sm text-center border-0" value="1" min="1" step="1">
                                    <div class="input-group-btn">
                                        <button class="btn btn-sm btn-plus rounded-circle bg-light border">
                                            <i class="fa fa-plus"></i>
                                        </button>
                                    </div>
                                </div>

                                <button type="button" id="add-to-cart" class="btn border border-secondary rounded-pill px-4 py-2 mb-4 text-primary">
                                    <i class="fa fa-shopping-bag me-2"></i> Add to cart
                                </button>
                            </div>
                            <div class="col-lg-12">
                                <nav>
                                    <div class="nav nav-tabs mb-3">
                                        <button class="nav-link active border-white border-bottom-0" data-bs-toggle="tab" data-bs-target="#tab-description">Description</button>
                                        <button class="nav-link border-white border-bottom-0" data-bs-toggle="tab" data-bs-target="#tab-reviews">Reviews</button>
                                    </div>
                                </nav>
                                <div class="tab-content mb-5">
                                    <div class="tab-pane active" id="tab-description">
                                        <p id="product-description"></p>
                                    </div>
                                    <div class="tab-pane" id="tab-reviews">
                                        <div id="reviews-container" class="d-flex flex-column gap-4">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <form action="#">
                                <h4 class="mb-5 fw-bold">Leave a Reply</h4>
                                <div class="row g-4">
                                    <div class="col-lg-6">
                                        <div class="border-bottom rounded">
                                            <input type="text" class="form-control border-0 me-4" placeholder="Yur Name *">
                                        </div>
                                    </div>
                                    <div class="col-lg-6">
                                        <div class="border-bottom rounded">
                                            <input type="email" class="form-control border-0" placeholder="Your Email *">
                                        </div>
                                    </div>
                                    <div class="col-lg-12">
                                        <div class="border-bottom rounded my-4">
                                            <textarea name="" id="" class="form-control border-0" cols="30" rows="8" placeholder="Your Review *" spellcheck="false"></textarea>
                                        </div>
                                    </div>
                                    <div class="col-lg-12">
                                        <div class="d-flex justify-content-between py-3 mb-5">
                                            <div class="d-flex align-items-center">
                                                <p class="mb-0 me-3">Please rate:</p>
                                                <div class="d-flex align-items-center" style="font-size: 12px;">
                                                    <i class="fa fa-star text-muted"></i>
                                                    <i class="fa fa-star"></i>
                                                    <i class="fa fa-star"></i>
                                                    <i class="fa fa-star"></i>
                                                    <i class="fa fa-star"></i>
                                                </div>
                                            </div>
                                            <a href="#" class="btn border border-secondary text-primary rounded-pill px-4 py-3"> Post Comment</a>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="col-lg-4 col-xl-3">
                        <div class="row g-4 fruite">
                            <div class="col-lg-12">
                                <div class="input-group w-100 mx-auto d-flex mb-4">
                                    <input type="search" class="form-control p-3" placeholder="keywords" aria-describedby="search-icon-1">
                                    <span id="search-icon-1" class="input-group-text p-3"><i class="fa fa-search"></i></span>
                                </div>
                            </div>
                            <div class="col-lg-12">
                                <h4 class="mb-3">Featured products</h4>
                                <div id="featured-products-list" class="d-flex flex-column gap-3">
                                </div>
                                <div class="d-flex justify-content-center my-4">
                                    <button 
                                        id="featured-view-more" 
                                        class="btn border border-secondary px-4 py-3 rounded-pill text-primary w-100"
                                        type="button"
                                    >
                                        View More
                                    </button>
                                </div>
                            </div>
                            <div class="col-lg-12">
                                <div class="position-relative">
                                    <img src="{% static 'img/banner-fruits.jpg' %}" class="img-fluid w-100 rounded" alt="">
                                    <div class="position-absolute" style="top: 50%; right: 10px; transform: translateY(-50%);">
                                        <h3 class="text-secondary fw-bold">Menjual <br> Gaming PC <br> Terlengkap</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <h1 class="fw-bold mb-0">Related products</h1>
                <div class="vesitable">
                    <div class="owl-carousel vegetable-carousel justify-content-center">

                    </div>
                </div>
            </div>
        </div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    function renderStars(rating) {
        const full = Math.floor(rating),
            half = (rating - full) >= 0.5,
            empty = 5 - full - (half ? 1 : 0);
        let html = '';
        for (let i = 0; i < full; i++)   html += '<i class="fas fa-star text-warning"></i>';
        if (half)                        html += '<i class="fas fa-star-half-alt text-warning"></i>';
        for (let i = 0; i < empty; i++)  html += '<i class="far fa-star text-secondary"></i>';
        return html;
    }
    const productDetailUrlTpl      = "{% url 'user_product:api-product-detail' slug='__SLUG__' %}";
    const relatedByCategoryUrlTpl  = "{% url 'user_category:api-productrelated' id='__CATID__' %}";
    const cartUrl                  = "{% url 'user_cart:api-cart' %}";
    const bestSellingUrl           = "{% url 'user_product:api-bestselling' %}";

    function buildUrl(template, placeholder, value) {
      return template.replace(placeholder, encodeURIComponent(value));
    }

    const imageLinkEl    = document.getElementById('product-image-link');
    const titleEl        = document.getElementById('product-title');
    const breadcrumbEl   = document.getElementById('product-breadcrumb');
    const detailEl       = document.getElementById('product-detail');
    const categoryEl     = document.getElementById('product-category');
    const priceEl        = document.getElementById('product-price');
    const ratingEl       = document.getElementById('product-rating');
    const descriptionEl  = document.getElementById('product-description');
    const variantsEl     = document.getElementById('variant-options');
    const reviewsEl      = document.getElementById('reviews-container');

    const slug = window.location.pathname.split('/').filter(Boolean).pop();

    const imageEl      = document.getElementById('product-image');
    const spinnerEl    = document.getElementById('image-spinner');
    const thumbnailsEl = document.getElementById('thumbnails');
    const prevBtn      = document.getElementById('prev-image');
    const nextBtn      = document.getElementById('next-image');

    const thumbPrevBtn  = document.getElementById('thumb-prev');
    const thumbNextBtn  = document.getElementById('thumb-next');
    const thumbContainer= document.getElementById('thumb-container');
    titleEl.textContent = '';

    reviewsEl.innerHTML = `<div class="text-center py-5"><div class="spinner-border"></div></div>`;

    let galleryImages = [];
    let currentIndex  = 0;
    let autoTimer;

    function setMainImage(idx) {
        currentIndex = idx;

        spinnerEl.style.display    = 'block';
        imageEl.style.visibility   = 'hidden';

        imageEl.onload = () => {
            spinnerEl.style.display  = 'none';
            imageEl.style.visibility = 'visible';
        };

        imageEl.src  = galleryImages[idx];
        imageLinkEl.href = galleryImages[idx];

        Array.from(thumbnailsEl.children).forEach((thumb, i) => {
            if (i === idx) {
                thumb.classList.add('active');
                thumb.style.opacity     = '1';
                thumb.style.borderColor = '#0d6efd';
            } else {
                thumb.classList.remove('active');
                thumb.style.opacity     = '0.6';
                thumb.style.borderColor = 'transparent';
            }
        });
    }

    function startAutoRotate() {
        if (autoTimer) clearInterval(autoTimer);
        autoTimer = setInterval(() => {
            setMainImage((currentIndex + 1) % galleryImages.length);
        }, 10000);
    }

    const rupiahFmt = new Intl.NumberFormat('id-ID', {
        style: 'currency',
        currency: 'IDR',
        minimumFractionDigits: 2
    });

    fetch(buildUrl(productDetailUrlTpl, '__SLUG__', slug))
    .then(r => {
      if (!r.ok) throw new Error(r.status === 404 ? 'not-found' : 'network');
      return r.json();
    })
    .then(p => {
        imageEl.src = p.image;
        imageEl.alt = p.title;
        imageLinkEl.href = `/product/${p.slug}/`;

        titleEl.textContent       = p.title;
        breadcrumbEl.textContent  = p.title;
        categoryEl.textContent    = 'Category: ' + p.category.name;
        priceEl.textContent       = rupiahFmt.format(p.price / 100).replace(/\u00A0/, '');
        ratingEl.innerHTML        = renderStars(p.averageRating || p.average_rating);
        descriptionEl.textContent = p.description;

        if (Array.isArray(p.products_variation) && p.products_variation.length) {
            const groupName = 'variant';
            const radios = p.products_variation.map((v, i) => `
            <div class="form-check">
                <input class="form-check-input" type="radio" name="${groupName}" id="var-${i}" value="${v.id}" ${i===0?'checked':''}>
                <label class="form-check-label" for="var-${i}">${v.name}</label>
            </div>
            `).join('');
            variantsEl.insertAdjacentHTML('beforeend', radios);
        }

        reviewsEl.innerHTML = '';
        if (p.review_products.length === 0) {
            reviewsEl.innerHTML = '<p class="text-muted">No reviews yet.</p>';
        } else {
            p.review_products.forEach(r => {
            const date = new Date(r.created_at).toLocaleDateString();
            const stars = renderStars(r.star);
            const html = `
                <div class="d-flex">
                    <img src="{% static 'img/avatar.jpg' %}"
                        class="img-fluid rounded-circle me-3"
                        style="width:100px;height:100px"
                        alt="${r.user}">
                    <div>
                        <p class="mb-1 text-muted">${date}</p>
                        <div class="d-flex justify-content-between">
                            <h5>${r.user}</h5>
                            <div class="d-flex mb-2">${stars}</div>
                        </div>
                        <p>${r.comment}</p>
                    </div>
                </div>`;
            reviewsEl.insertAdjacentHTML('beforeend', html);
            });
        }

      const extras = (p.products_images||[])
        .map(pi=>pi.name)
        .filter((src,i,a)=>src!==p.image && a.indexOf(src)===i);
      galleryImages = [p.image, ...extras];

      thumbnailsEl.innerHTML = '';
      galleryImages.forEach((src,idx) => {
        const t = document.createElement('img');
        t.src = src;
        Object.assign(t.style, {
          height:'60px', marginRight:'8px', cursor:'pointer',
          transition:'opacity .2s, border-color .2s',
          border:'2px solid transparent', opacity:idx===0?'1':'0.6',
          flexShrink:'0'
        });
        if(idx===0) t.classList.add('active');
        t.addEventListener('click', () => { setMainImage(idx); startAutoRotate(); });
        thumbnailsEl.appendChild(t);
      });

      if(galleryImages.length>6) {
        thumbPrevBtn.style.display='block';
        thumbNextBtn.style.display='block';
      }

      const scrollAmount = thumbContainer.clientWidth;
      thumbPrevBtn.onclick = ()=>thumbContainer.scrollBy({left:-scrollAmount,behavior:'smooth'});
      thumbNextBtn.onclick = ()=>thumbContainer.scrollBy({left: scrollAmount,behavior:'smooth'});

      prevBtn.onclick = ()=>{ setMainImage((currentIndex-1+galleryImages.length)%galleryImages.length); startAutoRotate(); };
      nextBtn.onclick = ()=>{ setMainImage((currentIndex+1)%galleryImages.length); startAutoRotate(); };

      setMainImage(0);
      startAutoRotate();

        fetch(buildUrl(relatedByCategoryUrlTpl, '__CATID__', p.category.id))
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(cat => {
            const $carousel = $('.vegetable-carousel');
            $carousel.empty(); 

            cat.product_categories.forEach(prod => {
                const cardHtml = `
                    <div class="border border-primary rounded position-relative vesitable-item">
                        <div class="vesitable-img">
                            <img src="${prod.image}" class="img-fluid w-100 rounded-top" alt="${prod.title}">
                        </div>
                        <div class="text-white bg-primary px-3 py-1 rounded position-absolute"
                            style="top: 10px; right: 10px;">
                            ${cat.name}
                        </div>
                        <div class="p-4 pb-0 rounded-bottom">
                            <h4>${prod.title}</h4>
                            <p>${prod.description.slice(0,60)}…</p>
                            <div class="d-flex justify-content-between flex-lg-wrap">
                            <p class="text-dark fs-5 fw-bold">
                                ${(prod.price/100).toLocaleString('en-US',{style:'currency',currency:'USD'})}
                            </p>
                            <a href="/product/${prod.slug}/"
                                class="btn border border-secondary rounded-pill px-3 py-1 mb-4 text-primary">
                                <i class="fa fa-shopping-bag me-2"></i>View
                            </a>
                            </div>
                        </div>
                    </div>`;
                    $carousel.append(cardHtml);
                });

                if ($carousel.hasClass('owl-loaded')) {
                    $carousel.trigger('destroy.owl.carousel');
                    $carousel.removeClass('owl-loaded');
                }
                $carousel.owlCarousel({
                loop:    false,
                margin:  30,
                nav:     true,
                navText: ['‹','›'],
                responsive: {
                    0:   { items: 1 },
                    576: { items: 2 },
                    768: { items: 3 },
                    992: { items: 4 }
                }
            });
        })
        .catch(() => {
            $('.vegetable-carousel').html('<p class="text-muted">No related products.</p>');
        });

        const qtyInput = document.getElementById('qty-input');

        function getQty() {
            const n = Number(qtyInput.value);
            return Number.isInteger(n) && n > 0 ? n : 1;
        }

        function showToast(message, type = 'info') {
            Toastify({
                text: message,
                duration: 3000,
                gravity: 'top',
                position: 'center',
                backgroundColor:
                type === 'success' ? 'linear-gradient(to right, #00b09b, #96c93d)' :
                type === 'error'   ? 'linear-gradient(to right, #e52d27, #b31217)' :
                'linear-gradient(to right, #333, #555)'
            }).showToast();
        }

        document.getElementById('add-to-cart').addEventListener('click', e => {
            e.preventDefault();

            const variantEl = document.querySelector('input[name="variant"]:checked');
            if (!variantEl) {
                return showToast('Please select a variant.', 'error');
            }

            const variantId = variantEl.value;
            const qty       = getQty();
            const productId = p.id;

            fetch(cartUrl, {
                method: 'POST',
                credentials: 'include',
                headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.cookie.split('user_session=')[1]?.split(';')[0] || ''
                },
                body: JSON.stringify({ quantity: qty, product: productId, variant: variantId })
            })
            .then(res => {
                if (res.status === 401) {
                window.location.href = '/login/';
                throw new Error('Redirecting to login');
                }
                if (!res.ok) {
                return res.json().then(err => Promise.reject(err));
                }
                return res.json();
            })
            .then(() => {
                showToast('Added to cart!', 'success');
            })
            .catch(err => {
                if (err.message === 'Redirecting to login') return;
                console.error('Cart error', err);

                const msg =
                err.variant?.[0] ||
                err.message ||
                'Unable to add to cart';

                showToast(msg, 'error');
            });
        });

    })
    .catch(err => {
        const msg = err.message === 'not-found'
        ? 'Product not found.'
        : 'Unable to load product.';
        document.getElementById('product-detail').innerHTML = `
        <div class="alert alert-danger">${msg}</div>`;
    });

    const container = document.getElementById('featured-products-list');
    const viewMore  = document.getElementById('featured-view-more');
    let shownCount  = 0;
    const perBatch  = 3;

    fetch(bestSellingUrl)
    .then(r => {
        if (!r.ok) throw new Error();
        return r.json();
        })
    .then(products => {
        if (!products.length) {
            container.innerHTML = `
            <div class="alert alert-info" role="alert">
                No featured products to show.
            </div>`;
            viewMore.style.display = 'none';
            return;
        }

        function renderBatch() {
            const next = products.slice(shownCount, shownCount + perBatch);
            next.forEach(p => {
            const priceStr = (p.price / 100).toLocaleString('id-ID', {
                style: 'currency', currency: 'IDR', minimumFractionDigits: 2
            });
            const itemHTML = `
                <div class="d-flex align-items-start gap-3">
                    <a href="/products/${p.slug}/" style="flex-shrink:0; width:80px; height:80px;">
                        <img src="${p.image}" class="img-fluid w-100 rounded" alt="${p.title}">
                    </a>
                    <div>
                        <h6 class="mb-1">
                        <a href="/products/${p.slug}/" class="text-decoration-none text-dark">
                            ${p.title}
                        </a>
                        </h6>
                        <div class="d-flex align-items-center">
                            ${renderStars(p.average_rating)}
                            <span class="ms-2 text-secondary">${p.average_rating.toFixed(1)}</span>
                        </div>
                        <div class="d-flex align-items-baseline">
                            <h5 class="fw-bold me-2 mb-0">${priceStr}</h5>
                            ${p.original_price
                                ? `<h5 class="text-danger text-decoration-line-through mb-0">
                                    ${(p.original_price/100).toLocaleString('id-ID',{
                                        style:'currency',currency:'IDR',minimumFractionDigits:2
                                    })}
                                </h5>`
                                : ''}
                        </div>
                    </div>
                </div>`;
                container.insertAdjacentHTML('beforeend', itemHTML);
            });
            shownCount += next.length;
            if (shownCount >= products.length) {
                viewMore.style.display = 'none';
            }
        }

        renderBatch();

        viewMore.addEventListener('click', () => {
            renderBatch();
        });

 
    })
    .catch(() => {
        container.innerHTML = `
            <div class="alert alert-danger" role="alert">
            Failed to load featured products. Please try again later.
            </div>`;
        viewMore.style.display = 'none';
    });

    ;(function() {
        const detailGroup = document.querySelector('.input-group.w-100.mx-auto.d-flex.mb-4');
        if (!detailGroup) return;

        const input   = detailGroup.querySelector('input[type="search"]');
        const trigger = detailGroup.querySelector('.input-group-text');

        function doDetailSearch() {
            const term = input.value.trim();
            const base = '/products/';
            const url  = term
            ? `${base}?search=${encodeURIComponent(term)}`
            : base;
            window.location.href = url;
        }

        input.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
            e.preventDefault();
            doDetailSearch();
            }
        });

        trigger.addEventListener('click', e => {
            e.preventDefault();
            doDetailSearch();
        });
    })();
});
</script>
{% endblock %}
